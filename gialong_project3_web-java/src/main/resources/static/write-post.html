<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Vi·∫øt b√†i m·ªõi - VLP BLOG</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #00c853; --text: #e0e0e0; --border: #333; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; margin: 0; }

        /* --- HEADER ƒê·ªíNG B·ªò --- */
        header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 3rem; background-color: #000; border-bottom: 1px solid var(--border); }
        .logo { font-size: 1.8rem; font-weight: bold; color: var(--accent); letter-spacing: 2px; cursor: pointer; text-decoration: none; }
        nav ul { list-style: none; margin: 0; padding: 0; display: flex; align-items: center; }
        nav li { margin-left: 2rem; }
        nav a { text-decoration: none; color: #fff; font-weight: 500; transition: 0.3s; }
        nav a:hover { color: var(--accent); }
        .btn-logout { border: 1px solid #555; padding: 5px 15px; border-radius: 4px; color: #ccc; }
        .btn-logout:hover { border-color: var(--accent); color: var(--accent); }

        /* --- FORM CONTAINER --- */
        .container { max-width: 800px; margin: 40px auto; background: var(--card); padding: 40px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.5); }

        h2 { border-left: 5px solid var(--accent); padding-left: 15px; margin-bottom: 30px; color: #fff; text-transform: uppercase; }

        label { display: block; margin-bottom: 8px; color: #b3b3b3; font-size: 0.85rem; text-transform: uppercase; font-weight: bold; margin-top: 20px; }

        input, textarea, select {
            width: 100%; padding: 12px;
            background: #2d2d2d; border: 1px solid var(--border); color: #fff; border-radius: 8px; font-size: 1rem; font-family: inherit;
            transition: 0.3s;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 5px rgba(0, 200, 83, 0.3); }

        .btn-post {
            background: var(--accent); color: #000; font-weight: bold; padding: 16px; margin-top: 30px;
            border: none; border-radius: 40px; width: 100%; cursor: pointer; font-size: 1.1rem;
            text-transform: uppercase; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-post:hover { background: #00e676; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 200, 83, 0.3); }

        .loading-overlay { display: none; color: var(--accent); text-align: center; margin-bottom: 15px; font-style: italic; }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo">VLP BLOG</a>
    <nav>
        <ul>
            <li><a href="index.html">Trang ch·ªß</a></li>
            <li><a href="posts.html">B√†i vi·∫øt</a></li>
            <li><a href="#" class="btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</a></li>
        </ul>
    </nav>
</header>

<div class="container">
    <h2><i class="fas fa-edit"></i> T·∫°o b√†i vi·∫øt m·ªõi</h2>
    <div id="loading" class="loading-overlay"><i class="fas fa-spinner fa-spin"></i> ƒêang k·∫øt n·ªëi t·ªõi m√°y ch·ªß...</div>

    <form id="writeForm">
        <label>Ti√™u ƒë·ªÅ b√†i vi·∫øt</label>
        <input type="text" id="title" required placeholder="V√≠ d·ª•: L·∫≠p tr√¨nh Java Spring Boot c∆° b·∫£n...">

        <label>M√¥ t·∫£ ng·∫Øn (Description)</label>
        <input type="text" id="description" required placeholder="T√≥m t·∫Øt n·ªôi dung ƒë·ªÉ hi·ªÉn th·ªã tr√™n th·∫ª b√†i vi·∫øt...">

        <label>Danh m·ª•c</label>
        <select id="categorySelect" required>
            <option value="">-- ƒêang t·∫£i danh m·ª•c... --</option>
        </select>

        <label>·∫¢nh b√¨a (URL)</label>
        <input type="text" id="imageUrl" placeholder="Link ·∫£nh (VD: https://i.imgur.com/...)">

        <label>N·ªôi dung chi ti·∫øt</label>
        <textarea id="content" rows="12" required placeholder="Vi·∫øt n·ªôi dung ch√≠nh t·∫°i ƒë√¢y..."></textarea>

        <button type="submit" class="btn-post" id="submitBtn">
            <i class="fas fa-paper-plane"></i> XU·∫§T B·∫¢N B√ÄI VI·∫æT
        </button>
    </form>
</div>

<script>
    const API_URL = 'http://localhost:8080/api';

    // --- 1. KI·ªÇM TRA ƒêƒÇNG NH·∫¨P NGAY KHI LOAD ---
    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem('blog_token');
        if (!token) {
            alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ vi·∫øt b√†i!");
            window.location.href = 'login.html';
        } else {
            fetchCategories(); // Ch·ªâ t·∫£i danh m·ª•c khi ƒë√£ c√≥ token
        }
    });

    // --- 2. T·∫¢I DANH M·ª§C ---
    async function fetchCategories() {
        try {
            const res = await fetch(`${API_URL}/categories`);
            if (!res.ok) throw new Error();
            const data = await res.json();

            const select = document.getElementById('categorySelect');
            select.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
            data.forEach(cat => {
                select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
        } catch (e) {
            document.getElementById('categorySelect').innerHTML = '<option value="">L·ªói t·∫£i danh m·ª•c (C√≥ th·ªÉ ch∆∞a ch·∫°y Backend)</option>';
        }
    }

    // --- 3. X·ª¨ L√ù ƒêƒÇNG B√ÄI ---
    document.getElementById('writeForm').onsubmit = async (e) => {
        e.preventDefault();

        // L·∫§Y TOKEN (Quan tr·ªçng nh·∫•t ƒë·ªÉ tr√°nh l·ªói 401)
        const token = localStorage.getItem('blog_token');
        if(!token) {
            alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
            window.location.href = 'login.html';
            return;
        }

        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');

        // Payload
        const payload = {
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            content: document.getElementById('content').value,
            imageUrl: document.getElementById('imageUrl').value,
            categoryId: parseInt(document.getElementById('categorySelect').value)
        };

        // UI Loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêANG G·ª¨I...';
        loading.style.display = 'block';

        try {
            const res = await fetch(`${API_URL}/posts`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // --- D√íNG QUAN TR·ªåNG ƒê·ªÇ S·ª¨A L·ªñI C·ª¶A B·∫†N ---
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("üéâ B√†i vi·∫øt ƒë√£ ƒë∆∞·ª£c xu·∫•t b·∫£n th√†nh c√¥ng!");
                window.location.href = 'index.html'; // Chuy·ªÉn v·ªÅ trang ch·ªß
            } else if (res.status === 401) {
                alert("‚õî L·ªói 401: B·∫°n kh√¥ng c√≥ quy·ªÅn ƒëƒÉng b√†i (Token h·∫øt h·∫°n ho·∫∑c kh√¥ng ph·∫£i Admin).");
            } else {
                const error = await res.json();
                alert("L·ªói t·ª´ m√°y ch·ªß: " + (error.message || "Ki·ªÉm tra l·∫°i d·ªØ li·ªáu!"));
            }
        } catch (err) {
            alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß! Vui l√≤ng ki·ªÉm tra Backend.");
            console.error(err);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> XU·∫§T B·∫¢N B√ÄI VI·∫æT';
            loading.style.display = 'none';
        }
    };

    function logout() {
        if(confirm("B·∫°n mu·ªën ƒëƒÉng xu·∫•t?")) {
            localStorage.removeItem('blog_token');
            localStorage.removeItem('user_role');
            window.location.href = 'login.html';
        }
    }
</script>
</body>
</html>